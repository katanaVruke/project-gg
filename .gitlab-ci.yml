# .gitlab-ci.yml для Flutter проекта
# Исправленная версия (без ошибок синтаксиса)

# =================== ПЕРЕМЕННЫЕ И НАСТРОЙКИ ===================
variables:
  FLUTTER_VERSION: "3.13.9"
  
# Кэширование для ускорения сборок
cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - .pub-cache/
    - .flutter-plugins
    - .flutter-plugins-dependencies
    - android/.gradle/caches/

# =================== СТАДИИ ПАЙПЛАЙНА ===================
stages:
  - lint           # Проверка кода
  - test           # Тестирование
  - build          # Сборка
  - deploy         # Деплой
  - notification   # Нотификация
  - documentation  # Документация
  - release        # Релиз

# =================== БАЗОВЫЕ СКРИПТЫ ===================
.before_script_default: &before_script_default
  - echo "Начинаем выполнение джобы: $CI_JOB_NAME"
  - echo "Ветка: $CI_COMMIT_REF_NAME"
  - echo "Коммит: $CI_COMMIT_SHORT_SHA"

.before_script_flutter: &before_script_flutter
  - *before_script_default
  - echo "Устанавливаем Flutter $FLUTTER_VERSION..."
  - wget -q https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_${FLUTTER_VERSION}-stable.tar.xz
  - tar xf flutter_linux_${FLUTTER_VERSION}-stable.tar.xz
  - export PATH="$PWD/flutter/bin:$PATH"
  - flutter --version
  - flutter pub get

# =================== ЛИНТЕР ===================
lint:
  stage: lint
  before_script:
    - *before_script_default
  script:
    - echo "Устанавливаем Flutter для линтинга..."
    - wget -q https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_${FLUTTER_VERSION}-stable.tar.xz
    - tar xf flutter_linux_${FLUTTER_VERSION}-stable.tar.xz
    - export PATH="$PWD/flutter/bin:$PATH"
    - echo "Запуск линтера..."
    - flutter analyze lib/
    - echo "Проверка форматирования..."
    - flutter format --set-exit-if-changed lib/
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
      changes:
        - "lib/**/*"
        - "pubspec.yaml"
  tags:
    - docker
  interruptible: true

# =================== ТЕСТИРОВАНИЕ ===================
test:
  stage: test
  before_script:
    - *before_script_default
  script:
    - echo "Устанавливаем Flutter для тестов..."
    - wget -q https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_${FLUTTER_VERSION}-stable.tar.xz
    - tar xf flutter_linux_${FLUTTER_VERSION}-stable.tar.xz
    - export PATH="$PWD/flutter/bin:$PATH"
    - flutter pub get
    - echo "Запуск тестов..."
    - flutter test
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
  tags:
    - docker
  interruptible: true

# =================== СБОРКА ANDROID ===================
build_android:
  stage: build
  before_script:
    - *before_script_flutter
  script:
    - echo "Сборка Android APK..."
    - flutter build apk --release
    - echo "APK собран: $(ls -la build/app/outputs/flutter-apk/app-release.apk 2>/dev/null || echo 'APK не найден')"
  artifacts:
    paths:
      - build/app/outputs/flutter-apk/app-release.apk
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_TAG'
      changes:
        - "lib/**/*"
        - "pubspec.yaml"
        - "android/**/*"
  tags:
    - docker
  interruptible: true

# =================== ПРОСТАЯ ДЖОБА ДЛЯ ТЕСТА ===================
test_pipeline:
  stage: lint
  script:
    - echo "✅ CI/CD пайплайн работает!"
    - echo "Проект: $CI_PROJECT_NAME"
    - echo "Ветка: $CI_COMMIT_REF_NAME"
    - echo "Коммит: $CI_COMMIT_SHORT_SHA"
  tags:
    - docker
  interruptible: true