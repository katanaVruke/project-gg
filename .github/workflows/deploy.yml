name: Deploy to Server
on:
  workflow_run:
    workflows: ["Build and Test"]
    types:
      - completed
    branches: [main]

jobs:
  deploy:
    name: Deploy APK to Server
    runs-on: self-hosted

    environment:
      name: production
      url: http://192.168.0.7:8080/

    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    
    steps:
      - name: Download APK from build workflow
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Rename APK with timestamp
        run: |
          mv app-release.apk "app-$(date +'%Y%m%d-%H%M%S').apk"
          echo "APK renamed to: $(ls *.apk)"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          # –î–æ–±–∞–≤–ª—è–µ–º —Ö–æ—Å—Ç –≤ known_hosts
          ssh-keyscan -T 5 -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Copy APK to server via scp
        run: |
          scp -o ConnectTimeout=10 -i ~/.ssh/id_ed25519 *.apk ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/flutter_builds/
          echo "‚úÖ APK copied successfully"

      - name: Update server files and create webpage
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd /var/www/flutter_builds
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏–º–ª–∏–Ω–∫ latest.apk
            LATEST_APK=\$(ls -t app-*.apk | head -1)
            rm -f latest.apk
            ln -s \"\$LATEST_APK\" latest.apk
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–±–æ—Ä–∫–µ
            BUILD_DATE=\$(date '+%d.%m.%Y, %H:%M')
            APK_SIZE=\$(du -h latest.apk | cut -f1)
            
            # –°–æ–∑–¥–∞—ë–º –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π HTML
            cat > index.html << 'HTML_EOF'
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset=\"UTF-8\">
                <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
                <title>${{ github.event.workflow_run.head_repository.full_name }}</title>
                <style>
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                        max-width: 600px;
                        margin: 100px auto;
                        padding: 40px;
                        text-align: center;
                        color: #333;
                        background: #f8f9fa;
                    }
                    h1 {
                        font-size: 2.8rem;
                        margin-bottom: 10px;
                        color: #2c3e50;
                    }
                    .subtitle {
                        color: #7f8c8d;
                        font-size: 1.2rem;
                        margin-bottom: 40px;
                    }
                    .info {
                        background: white;
                        padding: 25px;
                        border-radius: 12px;
                        margin: 30px 0;
                        border: 1px solid #e1e8ed;
                        text-align: left;
                    }
                    .info p {
                        margin: 10px 0;
                        font-size: 1.1rem;
                    }
                    .download-btn {
                        display: inline-block;
                        background: #3498db;
                        color: white;
                        padding: 18px 40px;
                        border-radius: 10px;
                        font-size: 1.4rem;
                        font-weight: 600;
                        text-decoration: none;
                        margin: 25px 0;
                        transition: background 0.2s;
                    }
                    .download-btn:hover {
                        background: #2980b9;
                    }
                    .size {
                        color: #95a5a6;
                        font-size: 0.9rem;
                        margin-top: 10px;
                    }
                    .divider {
                        height: 1px;
                        background: #e1e8ed;
                        margin: 30px 0;
                    }
                </style>
            </head>
            <body>
                <h1>${{ github.event.workflow_run.head_repository.full_name }}</h1>
                <p class=\"subtitle\">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–±–æ—Ä–∫–∏ Flutter –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</p>
                
                <div class=\"info\">
                    <p><strong>üìÖ –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–±–æ—Ä–∫–∞:</strong> <span id=\"build-date\">\$BUILD_DATE</span></p>
                    <p><strong>üîß –ö–æ–º–º–∏—Ç:</strong> ${{ github.event.workflow_run.head_sha }}</p>
                    <p><strong>üåê –í–æ—Ä–∫—Ñ–ª–æ—É:</strong> <a href=\"${{ github.event.workflow_run.html_url }}\" target=\"_blank\">#${{ github.event.workflow_run.id }}</a></p>
                </div>
                
                <div class=\"divider\"></div>
                
                <h2>–°–∫–∞—á–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é</h2>
                <p>–í—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–±–æ—Ä–∫–∞</p>
                
                <a href=\"latest.apk\" class=\"download-btn\">–°–ö–ê–ß–ê–¢–¨ APK</a>
                <p class=\"size\">(~\$APK_SIZE)</p>
            </body>
            </html>
            HTML_EOF
            
            echo \"‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞: \$LATEST_APK\"
            echo \"üåê –°—Å—ã–ª–∫–∞: http://${{ secrets.SSH_HOST }}:8080/\"
          "

  notify:
    name: Discord Notification
    runs-on: ubuntu-latest
    needs: [lint, test, build-android, deploy]
    if: always()
    
    steps:
    - name: Send Discord webhook
      uses: sarisia/actions-status-discord@v1
      env:
        DEPLOY_URL: http://${{ secrets.SSH_HOST }}:8080
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
        title: "üöÄ ${{ env.PROJECT_NAME }} - CI/CD Pipeline"
        description: |
          **Branch:** ${{ github.ref_name }}
          **Event:** ${{ github.event_name }}
          **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          **Status:** ${{ job.status }}
          
          **üì± APK –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ —Å—Å—ã–ª–∫–µ:**
          ${{ env.DEPLOY_URL }}
        color: ${{ job.status == 'success' && '00ff00' || 'ff0000' }}
        username: "GitHub Actions"
        avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

