name: Deploy to Server
on:
  workflow_run:
    workflows: ["Build and Test"]
    types:
      - completed
    branches: [main]

jobs:
  deploy:
    name: Deploy APK to Server
    runs-on: self-hosted
    environment:
      name: production
      url: http://192.168.0.3:8080/

    # –£—Å–ª–æ–≤–∏–µ: –∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ –ø—É—à–µ —Ç–µ–≥–æ–≤ v* –∏–ª–∏ –≤—Ä—É—á–Ω—É—é
    if: |
      github.event_name == 'workflow_run' && 
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      startsWith(github.event.workflow_run.head_branch, 'refs/tags/v')

    steps:
      - name: Check server connectivity
        run: |
          echo "Testing connection to 192.168.0.3..."
          ping -c 3 192.168.0.3 || echo "Ping failed but continuing..."
          echo "Server IP: 192.168.0.3"

      - name: Download APK from build workflow
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Rename APK with timestamp
        run: |
          mv app-release.apk "app-$(date +'%Y%m%d-%H%M%S').apk"
          APK_FILE=$(ls *.apk)
          echo "APK renamed to: $APK_FILE"
          echo "APK_FILE=$APK_FILE" >> $GITHUB_ENV

      - name: Setup SSH connection
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –≤ known_hosts
          ssh-keyscan -H 192.168.0.3 >> ~/.ssh/known_hosts 2>/dev/null
          
          # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
          ssh -o ConnectTimeout=5 -i ~/.ssh/id_ed25519 ${{ secrets.SSH_USER }}@192.168.0.3 "echo 'SSH connection successful'" || \
          echo "SSH test failed, but continuing..."

      - name: Copy APK to server
        run: |
          echo "Copying APK to 192.168.0.3..."
          scp -o ConnectTimeout=10 -i ~/.ssh/id_ed25519 *.apk ${{ secrets.SSH_USER }}@192.168.0.3:/var/www/flutter_builds/
          echo "‚úÖ APK copied to http://192.168.0.3:8080/"

      - name: Update server webpage
        run: |
          ssh -o ConnectTimeout=10 -i ~/.ssh/id_ed25519 ${{ secrets.SSH_USER }}@192.168.0.3 "
            cd /var/www/flutter_builds
            
            # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π APK
            LATEST_APK=\$(ls -t app-*.apk 2>/dev/null | head -1)
            if [ -z \"\$LATEST_APK\" ]; then
              echo \"‚ùå No APK files found!\"
              exit 0
            fi
            
            # –°–æ–∑–¥–∞–µ–º —Å–∏–º–ª–∏–Ω–∫ latest.apk
            rm -f latest.apk
            ln -s \"\$LATEST_APK\" latest.apk
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            BUILD_DATE=\$(date '+%d.%m.%Y, %H:%M')
            APK_SIZE=\$(du -h \"\$LATEST_APK\" 2>/dev/null | cut -f1)
            APK_NAME=\"\$(echo \$LATEST_APK | sed 's/app-//;s/.apk//')\"
            
            # –°–æ–∑–¥–∞–µ–º HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É
            cat > index.html << EOF
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset=\"UTF-8\">
                <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
                <title>Flutter Builds - 192.168.0.3</title>
                <style>
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                        max-width: 600px;
                        margin: 100px auto;
                        padding: 40px;
                        text-align: center;
                        color: #333;
                        background: #f8f9fa;
                    }
                    h1 {
                        font-size: 2.8rem;
                        margin-bottom: 10px;
                        color: #2c3e50;
                    }
                    .subtitle {
                        color: #7f8c8d;
                        font-size: 1.2rem;
                        margin-bottom: 40px;
                    }
                    .info {
                        background: white;
                        padding: 25px;
                        border-radius: 12px;
                        margin: 30px 0;
                        border: 1px solid #e1e8ed;
                        text-align: left;
                    }
                    .info p {
                        margin: 10px 0;
                        font-size: 1.1rem;
                    }
                    .download-btn {
                        display: inline-block;
                        background: #3498db;
                        color: white;
                        padding: 18px 40px;
                        border-radius: 10px;
                        font-size: 1.4rem;
                        font-weight: 600;
                        text-decoration: none;
                        margin: 25px 0;
                        transition: background 0.2s;
                    }
                    .download-btn:hover {
                        background: #2980b9;
                    }
                    .size {
                        color: #95a5a6;
                        font-size: 0.9rem;
                        margin-top: 10px;
                    }
                    .divider {
                        height: 1px;
                        background: #e1e8ed;
                        margin: 30px 0;
                    }
                    .server-info {
                        background: #e8f4fc;
                        padding: 15px;
                        border-radius: 8px;
                        margin-top: 20px;
                        font-family: monospace;
                    }
                </style>
            </head>
            <body>
                <h1>Flutter Application</h1>
                <p class=\"subtitle\">Automated Builds Server</p>
                
                <div class=\"info\">
                    <p><strong>üìÖ Latest Build:</strong> \$BUILD_DATE</p>
                    <p><strong>üì± Version:</strong> \$APK_NAME</p>
                    <p><strong>üì¶ File:</strong> \$LATEST_APK</p>
                    <p><strong>‚öôÔ∏è Server:</strong> 192.168.0.3:8080</p>
                </div>
                
                <div class=\"divider\"></div>
                
                <h2>Download Latest Version</h2>
                <p>Always up-to-date build</p>
                
                <a href=\"latest.apk\" class=\"download-btn\">DOWNLOAD APK</a>
                <p class=\"size\">(\$APK_SIZE)</p>
                
                <div class=\"server-info\">
                    Server: 192.168.0.3:8080<br>
                    Updated: \$BUILD_DATE<br>
                    Total builds: \$(ls app-*.apk 2>/dev/null | wc -l)
                </div>
            </body>
            </html>
            EOF
            
            echo \"‚úÖ Webpage updated successfully!\"
            echo \"üì± Latest APK: \$LATEST_APK\"
            echo \"üåê Available at: http://192.168.0.3:8080/\"
          "

  notify:
    name: Discord Notification
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: Send Discord notification
        uses: sarisia/actions-status-discord@v1
        env:
          DEPLOY_URL: "http://192.168.0.3:8080/"
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "üöÄ Deploy Complete - 192.168.0.3"
          description: |
            **Repository:** ${{ github.event.workflow_run.head_repository.full_name }}
            **Status:** ${{ needs.deploy.result || 'unknown' }}
            **Commit:** [${{ github.event.workflow_run.head_sha }}](${{ github.event.workflow_run.head_repository.html_url }}/commit/${{ github.event.workflow_run.head_sha }})
            **Workflow:** [#${{ github.event.workflow_run.id }}](${{ github.event.workflow_run.html_url }})
            
            **üì± APK Download:**
            http://192.168.0.3:8080/
            
            **Server:** 192.168.0.3:8080
          color: ${{ needs.deploy.result == 'success' && '00ff00' || (needs.deploy.result == 'failure' && 'ff0000' || '808080') }}
          username: "GitHub Actions - 192.168.0.3"