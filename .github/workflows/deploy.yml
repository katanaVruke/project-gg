---
name: Deploy to Production

on:
  workflow_run:
    workflows: ["Build Pipeline"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted
    environment: production
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      (github.event.workflow_run.event == 'push' && 
       (github.event.workflow_run.head_ref == 'main' || 
        startsWith(github.event.workflow_run.head_ref, 'refs/tags/v')))
    
    steps:
      - name: Debug environment
        run: |
          echo "Runner hostname: $(hostname)"
          echo "Working directory: $(pwd)"
          echo "Environment variables:"
          env | sort
      
      # –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —É–∂–µ –Ω–∞ —ç—Ç–æ–π –º–∞—à–∏–Ω–µ
      - name: Copy APK to web server
        run: |
          ARTIFACTS_DIR="${{ runner.temp }}/artifacts"
          TARGET_DIR="/var/www/flutter_builds"
          
          # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π APK
          APK_FILE=$(ls $ARTIFACTS_DIR/*.apk | head -1)
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          NEW_NAME="app-$TIMESTAMP.apk"
          
          cp "$APK_FILE" "$TARGET_DIR/$NEW_NAME"
          ln -sf "$TARGET_DIR/$NEW_NAME" "$TARGET_DIR/latest.apk"
          
          echo "‚úÖ Deployed: $NEW_NAME"
          echo "URL: http://192.168.0.3:8080/latest.apk"
      
      # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ HTML-—Å—Ç—Ä–∞–Ω–∏—Ü—ã
      - name: Update index.html
        run: |
          cd /var/www/flutter_builds
          LATEST=$(ls -t app-*.apk | head -1)
          SIZE=$(du -h "$LATEST" | cut -f1)
          DATE=$(date '+%d.%m.%Y %H:%M')
          
          cat > index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <title>Flutter Builds</title>
            <meta charset="utf-8">
          </head>
          <body>
            <h1>‚úÖ Latest Build</h1>
            <p><strong>Version:</strong> $LATEST</p>
            <p><strong>Date:</strong> $DATE</p>
            <p><strong>Size:</strong> $SIZE</p>
            <a href="latest.apk" download>‚¨áÔ∏è Download APK</a>
          </body>
          </html>
          EOF

  notify:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Discord Notification
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "üöÄ Deploy to 192.168.0.3"
          description: |
            **Status:** `${{ needs.deploy.result }}`
            **Version:** `${{ github.event.workflow_run.head_ref }}`
            **Download:** http://192.168.0.3:8080/latest.apk
            **Environment:** `production`
          color: ${{ needs.deploy.result == 'success' && '34C759' || 'FF3B30' }}