name: Flutter CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Позволяет запускать вручную

env:
  FLUTTER_VERSION: '3.13.9'
  PROJECT_NAME: 'Project-GG'

jobs:
  # =================== ЛИНТЕР ===================
  lint:
    name: Lint and Analyze
    runs-on: ubuntu-latest
    outputs:
      quality: ${{ steps.analyze.outputs.quality }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        cache-key: flutter-${{ env.FLUTTER_VERSION }}
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Run Flutter Analyze
      id: analyze
      run: |
        echo "Running Flutter analyze..."
        flutter analyze lib/ || echo "analyze_failed=true" >> $GITHUB_OUTPUT
        echo "quality=passed" >> $GITHUB_OUTPUT
    
    - name: Check Formatting
      run: |
        echo "Checking code formatting..."
        flutter format --set-exit-if-changed lib/
    
    - name: Debug Info
      if: always()
      run: |
        echo "=== DEBUG INFO ==="
        echo "Job: ${{ github.job }}"
        echo "Branch: ${{ github.ref }}"
        echo "Event: ${{ github.event_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "=================="

  # =================== ТЕСТЫ ===================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Run Tests
      run: flutter test --coverage
    
    - name: Upload Coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        fail_ci_if_error: false

  # =================== СБОРКА ANDROID ===================
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: test
    if: |
      github.event_name == 'push' && 
      (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    
    environment: 
      name: production
      url: https://github.com/${{ github.repository }}/releases
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
    
    - name: Install dependencies
      run: |
        flutter pub get
        echo "FLUTTER_VERSION=${{ env.FLUTTER_VERSION }}" >> $GITHUB_ENV
    
    - name: Build APK
      run: flutter build apk --release --verbose
    
    - name: Build App Bundle
      run: flutter build appbundle --release
    
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: build/app/outputs/flutter-apk/app-release.apk
        retention-days: 7
    
    - name: Upload App Bundle Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-appbundle
        path: build/app/outputs/bundle/release/app-release.aab
        retention-days: 7
    
    - name: Generate Build Info
      run: |
        echo "BUILD_DATE=$(date)" >> $GITHUB_ENV
        echo "BUILD_VERSION=${GITHUB_SHA::7}" >> $GITHUB_ENV
        echo "APP_NAME=${{ env.PROJECT_NAME }}" >> $GITHUB_ENV

  # =================== ДЕПЛОЙ ===================
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build-android
    if: github.ref == 'refs/heads/main'
    
    environment:
      name: production
      url: ${{ secrets.DEPLOY_URL }}
    
    steps:
    - name: Download APK Artifact
      uses: actions/download-artifact@v4
      with:
        name: android-apk
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Deploy via SSH (Simulation)
      env:
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      run: |
        echo "=== DEPLOYMENT SIMULATION ==="
        echo "Deploying to: $DEPLOY_HOST"
        echo "User: $DEPLOY_USER"
        echo "Path: $DEPLOY_PATH"
        echo "APK File: app-release.apk"
        echo "============================="
        
        # Реальный деплой был бы так (закомментирован):
        # scp -o StrictHostKeyChecking=no app-release.apk $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
        # ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST "ls -la $DEPLOY_PATH/"
        
        # Создаем файл для документации
        mkdir -p deploy-info
        echo "Deployed at: $(date)" > deploy-info/deployment.txt
        echo "Commit: $GITHUB_SHA" >> deploy-info/deployment.txt
        echo "Version: ${GITHUB_SHA::7}" >> deploy-info/deployment.txt
    
    - name: Upload Deployment Info
      uses: actions/upload-artifact@v4
      with:
        name: deployment-info
        path: deploy-info/
        retention-days: 30

  # =================== НОТИФИКАЦИЯ В DISCORD ===================
  notify-discord:
    name: Send Discord Notification
    runs-on: ubuntu-latest
    needs: [lint, test, build-android]
    if: always()
    
    steps:
    - name: Send Discord Webhook
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
        title: "CI/CD Pipeline - ${{ github.repository }}"
        description: |
          **Status:** ${{ job.status }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          **Workflow:** [${{ github.workflow }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ### Jobs Status:
          - ✅ Lint: ${{ needs.lint.result }}
          - ✅ Test: ${{ needs.test.result }}
          - ✅ Build: ${{ needs.build-android.result }}
          
          *Generated by GitHub Actions*
        color: ${{ job.status == 'success' && '0x00FF00' || '0xFF0000' }}
        username: "GitHub Actions Bot"
        avatar: "https://github.com/github.png"
        noproxy: true