---
name: Build Pipeline

on:
  push:
    branches: [main, develop]
    tags: ['v*.*.*']
    paths-ignore:
      - 'docs/**'
      - 'README.md'
  workflow_dispatch:
    inputs:
      force-deploy:
        description: 'Force deploy even without tag'
        type: boolean
        default: false

env:
  FLUTTER_VERSION: '3.24.0'
  PROJECT_NAME: 'Project-GG'

jobs:
  setup:
    runs-on: self-hosted
    outputs:
      flutter-version: ${{ env.FLUTTER_VERSION }}
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      - run: flutter pub get
      - run: flutter doctor -v
      - run: echo "DEBUG: Flutter setup complete on $(hostname)"

  test:
    needs: setup
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ needs.setup.outputs.flutter-version }}
      - run: flutter pub get
      - run: flutter test --coverage
      - uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          fail_ci_if_error: false

  build-android:
    needs: test
    runs-on: self-hosted
    if: |
      (github.ref == 'refs/heads/main' && github.event.inputs.force-deploy == 'true') ||
      startsWith(github.ref, 'refs/tags/v')
    environment: 
      name: production
      url: http://192.168.0.3:8080/
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      - run: flutter pub get
      
      # Сборка
      - run: flutter build apk --release
      - run: flutter build appbundle --release
      
      # Сохранение артефактов
      - run: |
          mkdir -p ${{ runner.temp }}/artifacts
          cp build/app/outputs/flutter-apk/app-release.apk ${{ runner.temp }}/artifacts/
          cp build/app/outputs/bundle/release/app-release.aab ${{ runner.temp }}/artifacts/
          echo "ARTIFACTS_DIR=${{ runner.temp }}/artifacts" >> $GITHUB_ENV
      
      # Генерация release notes
      - name: Generate Release Notes
        id: release_notes
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          if [[ -n "$TAG" ]]; then
            echo "## Release $TAG" > RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            git log $(git describe --tags --abbrev=0 $(git describe --tags --abbrev=0)^)..HEAD --oneline --no-merges | sed 's/^/- /' >> RELEASE_NOTES.md
            cat RELEASE_NOTES.md
          fi
      
      # Коммит release notes
      - name: Commit Release Notes
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add RELEASE_NOTES.md
          git commit -m "chore: add release notes for ${{ github.ref_name }}" || echo "No changes to commit"
          git push origin HEAD || echo "Push failed (expected for tags)"